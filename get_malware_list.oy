'''
symantec spider
get malware list
'''
__author__ = 'chishubiao'

import time
import requests
from bs4 import BeautifulSoup
import json

def get_table(html_result):
    bs_obj = BeautifulSoup(html_result,"lxml")
    trs = bs_obj.find("table", {"class" : "defaultTableStyle tableFontMD tableNoBorder"}).tbody.findAll("tr")
    result = []
    for tr in trs:
        data = {
            "url":tr.contents[2].find("a")["href"],
            "malware_name":tr.contents[2].find("a").get_text(),
            "type":tr.contents[3].get_text(),
            "date":tr.contents[4].get_text()
        }
        result.append(data)
    return result

def my_requests(url,index):
    header = {
        "User-Agent":"Mozilla/5.0 (Windows NT 10.0; WOW64; rv:43.0) Gecko/20100101 Firefox/43.0",
        "Cookies":"JSESSIONID=DcvFYQZChkZJr6gTLwD33BvhTkSsM3KnxVptDgwCKpdRDzGGPFXf!1126938155; BIGipServerpool_tus3-sngweb.symantec.com=892501903.20480.0000; AMCV_67C716D751E567F70A490D4C%40AdobeOrg=283337926%7CMCMID%7C78108908895620892799216242958132262913%7CMCAAMLH-1478070799%7C11%7CMCAAMB-1478070799%7CcIBAx_aQzFEHcPoEv0GwcQ%7CMCAID%7CNONE; symcSCDate=1480057998709; s_gpv=en%2Fus%3A%20biz%3A%20security%20response%3A%20a-z; s_nr=1477466281263-New; event69=event69; s_dmdbase=rsp%3Dmatch%26cData%3D%255Bn%2Fa%255D%253A%255Bn%2Fa%255D%253A%255Bn%2Fa%255D%253A%255Bn%2Fa%255D%253A%255Bn%2Fa%255D%253A%255Bn%2Fa%255D%253AWireless%253AMobile%2520Network%26cDataCustom%3D%255Bn%2Fa%255D%253A%255Bn%2Fa%255D%253A%255Bn%2Fa%255D%253A%255Bn%2Fa%255D%253A%255Bn%2Fa%255D%253A%255Bn%2Fa%255D%253A%255Bn%2Fa%255D%253A%255Bn%2Fa%255D%26sentAA%3DT; s_cc=true; _bizo_bzid=b46e861c-a0af-40a1-8269-258971409834; _bizo_cksm=DD18970CF51B11E5; _bizo_np_stats=14%3D1906%2C; s_sq=%5B%5BB%5D%5D; oo_exit=57ce1473dbc183bdf835d39974ba003b0e19c62e"
    }
    data = {
        "azid": index
    }
    return requests.get(url,headers=header,params=data).text

def get_list():
    url = "https://www.symantec.com/security_response/landing/azlisting.jsp"
    list = []
    for i in range(66,91):#B-Z
        time.sleep(1)
        result = get_table(my_requests(url,chr(i)))
        list.extend(result)

    return json.dumps(list)

if __name__ == "__main__":
    f = open("result.json","w+")
    f.write(get_list())
